<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.76.5" />
    <meta name="description" content="Overwatch Documentation">
<meta name="author" content="Daniel Tomes -- DatabricksLabs">

    <link rel="icon" href="https://databrickslabs.github.io/overwatch/images/favicon.png" type="image/png">

    <title>ETL Process :: Overwatch</title>

    
    <link href="https://databrickslabs.github.io/overwatch/css/nucleus.css?1624455023" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/fontawesome-all.min.css?1624455023" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/hybrid.css?1624455023" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/featherlight.min.css?1624455023" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/perfect-scrollbar.min.css?1624455023" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/auto-complete.css?1624455023" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/atom-one-dark-reasonable.css?1624455023" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/theme.css?1624455023" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/hugo-theme.css?1624455023" rel="stylesheet">
    
    <link href="https://databrickslabs.github.io/overwatch/css/theme-blue.css?1624455023" rel="stylesheet">
    
    

    <script src="https://databrickslabs.github.io/overwatch/js/jquery-3.3.1.min.js?1624455023"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    

<script async defer src="https://buttons.github.io/buttons.js"></script>
  </head>
  <body class="" data-url="https://databrickslabs.github.io/overwatch/dataengineer/etl_process/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://databrickslabs.github.io/overwatch/">
    <img src="https://databrickslabs.github.io/overwatch/images/tmp_logo4.png", width="85%">
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="https://databrickslabs.github.io/overwatch/js/lunr.min.js?1624455023"></script>
<script type="text/javascript" src="https://databrickslabs.github.io/overwatch/js/auto-complete.js?1624455023"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/databrickslabs.github.io\/overwatch\/";
    
</script>
<script type="text/javascript" src="https://databrickslabs.github.io/overwatch/js/search.js?1624455023"></script>

    
  </div>
  
  <section id="homelinks">
    <ul>
      <li>
        <a class="padding" href='https://databrickslabs.github.io/overwatch/'><i class='fas fa-home'></i> Home</a>
      </li>
    </ul>
  </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/gettingstarted/" title="Getting Started" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/gettingstarted/">
          Getting Started
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/gettingstarted/configuration/" title="Configuration" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/gettingstarted/configuration/">
        Configuration
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gettingstarted/modules/" title="Modules" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/gettingstarted/modules/">
        Modules
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gettingstarted/advancedtopics/" title="Advanced Topics" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/gettingstarted/advancedtopics/">
        Advanced Topics
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/environmentsetup/" title="Environment Setup" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/environmentsetup/">
          Environment Setup
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/environmentsetup/azure/" title="Azure" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/environmentsetup/azure/">
        Azure
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/environmentsetup/aws/" title="AWS" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/environmentsetup/aws/">
        AWS
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/dataengineer/" title="Data Engineering" class="dd-item
        parent
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/dataengineer/">
          Data Engineering
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/dataengineer/definitions/" title="Definitions" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/dataengineer/definitions/">
        Definitions
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dataengineer/etl_process/" title="ETL Process" class="dd-item active">
        <a href="https://databrickslabs.github.io/overwatch/dataengineer/etl_process/">
        ETL Process
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dataengineer/upgrade/" title="Upgrade" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/dataengineer/upgrade/">
        Upgrade
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/changelog/" title="ChangeLog" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/changelog/">
          ChangeLog
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/contributing/" title="" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/contributing/">
          
          
      </a>
      
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="footer">
      <center>

    
    <a class="github-button" href="https://github.com/databrickslabs/overwatch/subscription"
       data-icon="octicon-eye" data-show-count="true" aria-label="Watch Overwatch on GitHub">Watch</a>


    <a class="github-button" href="https://github.com/databrickslabs/overwatch" data-icon="octicon-star" data-show-count="true" aria-label="Star databrickslabs/overwatch on GitHub">Star</a>


    <a class="github-button" href="https://github.com/databrickslabs/overwatch/fork"
       data-icon="octicon-repo-forked" data-show-count="true" aria-label="Fork Overwatch on GitHub">Fork</a>

    <p>A <a href="https://github.com/databrickslabs">Databricks Labs</a> project.</p>
</center>

<script async defer src="https://buttons.github.io/buttons.js"></script>
    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='https://databrickslabs.github.io/overwatch/'>Welcome To OverWatch</a> > <a href='https://databrickslabs.github.io/overwatch/dataengineer/'>Data Engineering</a> > ETL Process
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#data-ingestion-and-resume-process">Data Ingestion and Resume Process</a>
      <ul>
        <li><a href="#the-overwatch-execution-process">The Overwatch Execution Process</a></li>
      </ul>
    </li>
    <li><a href="#the-pipeline-report">The Pipeline Report</a>
      <ul>
        <li><a href="#pipeline_report-structure">Pipeline_Report Structure</a></li>
      </ul>
    </li>
    <li><a href="#overwatch-time">Overwatch Time</a></li>
    <li><a href="#module-dependencies">Module Dependencies</a></li>
    <li><a href="#reloading-data">Reloading Data</a>
      <ul>
        <li><a href="#reloading-data-example">Reloading Data Example</a></li>
        <li><a href="#reloading-spark-data-silver">Reloading Spark Data (Silver)</a></li>
        <li><a href="#running-only-specific-layers">Running Only Specific Layers</a></li>
      </ul>
    </li>
    <li><a href="#cloud-specific-variations">Cloud-Specific Variations</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              ETL Process
            </h1>
          

        


<h2 id="data-ingestion-and-resume-process">Data Ingestion and Resume Process</h2>
<p>The specificities can vary slightly between cloud provider but the general methodology is the exact same. 
Specific differences will be discussed in <a href="#cloud-specific-variations">Cloud-Specific Variations</a> section.</p>
<p>Each module is responsible for building certain entities at each layer, bronze, silver, gold, and presentation.
The mapping between module and gold entity can be found in the <a href="https://databrickslabs.github.io/overwatch/gettingstarted/modules/">Modules</a> section.
Each module is also tracked individually in the primary tracking tabe, <a href="#the-pipeline-report"><strong>Pipeline_Report</strong></a>.</p>
<h3 id="the-overwatch-execution-process">The Overwatch Execution Process</h3>
<p>Each Overwatch Run takes a snapshot at a point in time and will be the uppermost timestamp for which any data will
be captured. Each Overwatch Run also derives an associated GUID by which it can be globally identified throughout
the run. Each record created during the run will have an associated <em>Overwatch_RunID</em> and <em>Pipeline_SnapTS</em> which can 
be used to determine exactly when a record was loaded.</p>
<p>The &ldquo;from_time&rdquo; will be derived dynamically for each module as per the previous run snapshot time
for the given module plus one millisecond. If the module has never been executed, the primordialDateString will be
used which is defined as current_date - 60 days, by default. This can be overridden in the 
<a href="https://databrickslabs.github.io/overwatch/gettingstarted/configuration/">config</a>. Some modules can be very slow / time-consuming on the 
first run due to the data volume and/or trickle loads from APIs. Best practice is to set your primordialDateString 
(if desired &gt; 60d) AND set &ldquo;<em>maxDaysToLoad</em>&rdquo; to a low number like 5. It&rsquo;s important to balance sufficient data to 
fully build out the implicit schemas and small enough data to get through an initial valid test.</p>
<p>More best practices can be found in the <a href="https://databrickslabs.github.io/overwatch/gettingstarted/advancedtopics/#best-practices">Best Practices</a> 
section; these are especially important to reference when getting started.</p>
<h2 id="the-pipeline-report">The Pipeline Report</h2>
<p>The Pipeline_Report table controls the start/stop points for each module and tracks the status of each run. 
Manipulating this table will change the way Overwatch executes so be sure to read the rest of this page before 
altering this table.</p>
<p>The Pipeline Report is very useful for identifying issues in the pipeline. Each module, each run is detailed here. 
The structure of the table is outlined below.</p>
<h3 id="pipeline_report-structure">Pipeline_Report Structure</h3>
<p><a href="https://databrickslabs.github.io/overwatch/assets/TableSamples/pipeline_report.tab"><strong>SAMPLE</strong></a></p>
<p><strong>KEY</strong> &ndash; organization_id + moduleID + Overwatch_RunID</p>
<p>For the developers &ndash; This output is created as a DataSet via the Case Class
<em>com.databricks.labs.overwatch.utils.ModuleStatusReport</em></p>
<table>
<thead>
<tr>
<th style="text-align:left">Column</th>
<th style="text-align:left">Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">organization_id</td>
<td style="text-align:left">string</td>
<td style="text-align:left">Canonical workspace id</td>
</tr>
<tr>
<td style="text-align:left">moduleId</td>
<td style="text-align:left">int</td>
<td style="text-align:left">Module ID &ndash; Unique identifier for the module</td>
</tr>
<tr>
<td style="text-align:left">moduleName</td>
<td style="text-align:left">string</td>
<td style="text-align:left">Name of the module</td>
</tr>
<tr>
<td style="text-align:left">runStartTS</td>
<td style="text-align:left">long</td>
<td style="text-align:left">Snapshot time of when the Overwatch run begins</td>
</tr>
<tr>
<td style="text-align:left">runEndTS</td>
<td style="text-align:left">long</td>
<td style="text-align:left">Snapshot time of when the Overwatch run ends</td>
</tr>
<tr>
<td style="text-align:left">fromTS</td>
<td style="text-align:left">long</td>
<td style="text-align:left">The snapshot start time from which data will be loaded for the module</td>
</tr>
<tr>
<td style="text-align:left">untilTS</td>
<td style="text-align:left">long</td>
<td style="text-align:left">The snapshot final time from which data will be loaded for the module. This is also the epoch millis of Pipeline_SnapTS</td>
</tr>
<tr>
<td style="text-align:left">dataFrequency</td>
<td style="text-align:left">string</td>
<td style="text-align:left">(milliSecond OR Daily) Most modules have a time resolution at the millisecond level; however there are certain modules that can only be run daily. This column is used by Overwatch internals to calculate start/stops for new data</td>
</tr>
<tr>
<td style="text-align:left">status</td>
<td style="text-align:left">string</td>
<td style="text-align:left">Terminal Status for the module run (SUCCEEDED, FAILED, ROLLED_BACK, EMPTY, etc). When status is failed, the error message and stack trace that can be obtained is also placed in this field to assist in finding issues</td>
</tr>
<tr>
<td style="text-align:left">recordsAppended</td>
<td style="text-align:left">long</td>
<td style="text-align:left">Count of records appended. Not always enabled for performance reasons, see <a href="https://databrickslabs.github.io/overwatch/gettingstarted/advancedtopics/">advanced topics</a> for additional information.</td>
</tr>
<tr>
<td style="text-align:left">lastOptimizedTS</td>
<td style="text-align:left">long</td>
<td style="text-align:left">Epoch millis of the last delta optimize run. Used by Overwatch internals to maintain healthy and optimized tables.</td>
</tr>
<tr>
<td style="text-align:left">vacuumRetentionHours</td>
<td style="text-align:left">int</td>
<td style="text-align:left">Retention hours for delta &ndash; How long to retain deleted data</td>
</tr>
<tr>
<td style="text-align:left">inputConfig</td>
<td style="text-align:left">struct</td>
<td style="text-align:left">Captured input of OverwatchParams config at time of module run</td>
</tr>
<tr>
<td style="text-align:left">parsedConfig</td>
<td style="text-align:left">struct</td>
<td style="text-align:left">The config that was parsed into OverwatchParams through the json deserializer</td>
</tr>
<tr>
<td style="text-align:left">Pipeline_SnapTS</td>
<td style="text-align:left">timestamp</td>
<td style="text-align:left">Timestamp type of the pipeline snapshot time (server time)</td>
</tr>
<tr>
<td style="text-align:left">Overwatch_RunID</td>
<td style="text-align:left">string</td>
<td style="text-align:left">GUID for the overwatch run</td>
</tr>
</tbody>
</table>
<h2 id="overwatch-time">Overwatch Time</h2>
<p>Overwatch will default timezone to that of the server / cluster on which it runs. This is a critical point to 
be aware of when aggregating Overwatch results from several workspaces across different regions.</p>
<h2 id="module-dependencies">Module Dependencies</h2>
<p>Several modules depend on other modules as source input; as such, as you can imagine, we don&rsquo;t want modules to 
progress if one of their dependencies is erroring out and not populating any data. To handle this, Modules have
dependencies such that upstream failures will cause downstream modules to be ineligible to continue. There are 
several types of errors that result in a module failure, and those errors are written out in the pipeline_report 
when they occur. Sometimes, there will truly be no new data in an upstream Module, this is ok and will not stop the 
progression of the &ldquo;until&rdquo; time as no data is not considered an error. Below are the ETL Modules and their dependencies</p>
<table>
<thead>
<tr>
<th style="text-align:left">Module ID</th>
<th style="text-align:left">Module Name</th>
<th style="text-align:left">Target Table Name</th>
<th style="text-align:left">Module ID Dependencies</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1001</td>
<td style="text-align:left">Bronze_Jobs_Snapshot</td>
<td style="text-align:left">jobs_snapshot_bronze</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">1002</td>
<td style="text-align:left">Bronze_Clusters_Snapshot</td>
<td style="text-align:left">clusters_snapshot_bronze</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">1003</td>
<td style="text-align:left">Bronze_Pools</td>
<td style="text-align:left">pools_snapshot_bronze</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">1004</td>
<td style="text-align:left">Bronze_AuditLogs</td>
<td style="text-align:left">audit_log_bronze</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">1005</td>
<td style="text-align:left">Bronze_ClusterEventLogs</td>
<td style="text-align:left">cluster_events_bronze</td>
<td style="text-align:left">1004</td>
</tr>
<tr>
<td style="text-align:left">1006</td>
<td style="text-align:left">Bronze_SparkEventLogs</td>
<td style="text-align:left">spark_events_bronze</td>
<td style="text-align:left">1004</td>
</tr>
<tr>
<td style="text-align:left">2003</td>
<td style="text-align:left">Silver_SPARK_Executors</td>
<td style="text-align:left">spark_executors_silver</td>
<td style="text-align:left">1006</td>
</tr>
<tr>
<td style="text-align:left">2005</td>
<td style="text-align:left">Silver_SPARK_Executions</td>
<td style="text-align:left">spark_executions_silver</td>
<td style="text-align:left">1006</td>
</tr>
<tr>
<td style="text-align:left">2006</td>
<td style="text-align:left">Silver_SPARK_Jobs</td>
<td style="text-align:left">spark_jobs_silver</td>
<td style="text-align:left">1006</td>
</tr>
<tr>
<td style="text-align:left">2007</td>
<td style="text-align:left">Silver_SPARK_Stages</td>
<td style="text-align:left">spark_stages_silver</td>
<td style="text-align:left">1006</td>
</tr>
<tr>
<td style="text-align:left">2008</td>
<td style="text-align:left">Silver_SPARK_Tasks</td>
<td style="text-align:left">spark_tasks_silver</td>
<td style="text-align:left">1006</td>
</tr>
<tr>
<td style="text-align:left">2010</td>
<td style="text-align:left">Silver_JobsStatus</td>
<td style="text-align:left">job_status_silver</td>
<td style="text-align:left">1004</td>
</tr>
<tr>
<td style="text-align:left">2011</td>
<td style="text-align:left">Silver_JobsRuns</td>
<td style="text-align:left">jobrun_silver</td>
<td style="text-align:left">1004,2010,2014</td>
</tr>
<tr>
<td style="text-align:left">2014</td>
<td style="text-align:left">Silver_ClusterSpec</td>
<td style="text-align:left">cluster_spec_silver</td>
<td style="text-align:left">1004</td>
</tr>
<tr>
<td style="text-align:left">2016</td>
<td style="text-align:left">Silver_AccountLogins</td>
<td style="text-align:left">accountlogin</td>
<td style="text-align:left">1004</td>
</tr>
<tr>
<td style="text-align:left">2017</td>
<td style="text-align:left">Silver_ModifiedAccounts</td>
<td style="text-align:left">account_mods_silver</td>
<td style="text-align:left">1004</td>
</tr>
<tr>
<td style="text-align:left">2018</td>
<td style="text-align:left">Silver_Notebooks</td>
<td style="text-align:left">notebook_silver</td>
<td style="text-align:left">1004</td>
</tr>
<tr>
<td style="text-align:left">3001</td>
<td style="text-align:left">Gold_Cluster</td>
<td style="text-align:left">cluster_gold</td>
<td style="text-align:left">2014</td>
</tr>
<tr>
<td style="text-align:left">3002</td>
<td style="text-align:left">Gold_Job</td>
<td style="text-align:left">job_gold</td>
<td style="text-align:left">2010</td>
</tr>
<tr>
<td style="text-align:left">3003</td>
<td style="text-align:left">Gold_JobRun</td>
<td style="text-align:left">jobrun_gold</td>
<td style="text-align:left">2011</td>
</tr>
<tr>
<td style="text-align:left">3004</td>
<td style="text-align:left">Gold_Notebook</td>
<td style="text-align:left">notebook_gold</td>
<td style="text-align:left">2018</td>
</tr>
<tr>
<td style="text-align:left">3005</td>
<td style="text-align:left">Gold_ClusterStateFact</td>
<td style="text-align:left">clusterstatefact_gold</td>
<td style="text-align:left">1005,2014</td>
</tr>
<tr>
<td style="text-align:left">3007</td>
<td style="text-align:left">Gold_AccountMod</td>
<td style="text-align:left">account_mods_gold</td>
<td style="text-align:left">2017</td>
</tr>
<tr>
<td style="text-align:left">3008</td>
<td style="text-align:left">Gold_AccountLogin</td>
<td style="text-align:left">account_login_gold</td>
<td style="text-align:left">2016</td>
</tr>
<tr>
<td style="text-align:left">3010</td>
<td style="text-align:left">Gold_SparkJob</td>
<td style="text-align:left">sparkjob_gold</td>
<td style="text-align:left">2006</td>
</tr>
<tr>
<td style="text-align:left">3011</td>
<td style="text-align:left">Gold_SparkStage</td>
<td style="text-align:left">sparkstage_gold</td>
<td style="text-align:left">2007</td>
</tr>
<tr>
<td style="text-align:left">3012</td>
<td style="text-align:left">Gold_SparkTask</td>
<td style="text-align:left">sparktask_gold</td>
<td style="text-align:left">2008</td>
</tr>
<tr>
<td style="text-align:left">3013</td>
<td style="text-align:left">Gold_SparkExecution</td>
<td style="text-align:left">sparkexecution_gold</td>
<td style="text-align:left">2005</td>
</tr>
<tr>
<td style="text-align:left">3014</td>
<td style="text-align:left">Gold_SparkExecutor</td>
<td style="text-align:left">sparkexecutor_gold</td>
<td style="text-align:left">2003</td>
</tr>
<tr>
<td style="text-align:left">3015</td>
<td style="text-align:left">Gold_jobRunCostPotentialFact</td>
<td style="text-align:left">jobruncostpotentialfact_gold</td>
<td style="text-align:left">3001,3003,3005,3010,3012</td>
</tr>
</tbody>
</table>
<h2 id="reloading-data">Reloading Data</h2>
<p><strong>CAUTION</strong> Be very careful when attempting to reload bronze data, much of the bronze source data expires to 
minimize storage costs. Reloading bronze data should be a very rare task (hopefully never necessary)</p>
<p>The need may arise to reload data. This can be easily accomplished by setting the &ldquo;Status&rdquo; column to &ldquo;ROLLED_BACK&rdquo; 
for the modules you wish to reload where:</p>
<ul>
<li>fromTime column &gt; some point in time OR</li>
<li>Overwatch_RunID === some Overwatch_Run_ID (useful if duplicates get loaded)</li>
</ul>
<p>Remember to specify the ModuleID for which you want to reload data.</p>
<h3 id="reloading-data-example">Reloading Data Example</h3>
<p><strong>Scenario</strong> Something has occurred and has corrupted the jobrun entity after 01-01-2021 but the issue wasn&rsquo;t 
identified until 02-02-2021. To fix this, all data from 12-31-2020 forward will be rolled back. Depending on the details,
the fromTime or the Pipeline_SnapTS could be used; for this scenario we will go back an extra day and use 
Pipeline_SnapTS as the incremental time column. Since we&rsquo;re using delta, we are safe to perform updates and deletes
without fear of losing data (In the event of an issue we could simply restore a previous version of the table).</p>

<div class="notices warning" ><p><a href="#reloading-spark-data-silver"><strong>Reloading spark silver</strong></a> requires one extra step. If reloading spark silver data click the link.</p>
</div>

<p>Steps:</p>
<ol>
<li>Verify Overwatch isn&rsquo;t currently running and isn&rsquo;t about to kick off for this workspace.</li>
<li>Delete from jobRun_silver table where Pipeline_SnapTS &gt;= &ldquo;2020-12-31&rdquo;</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">spark<span style="color:#f92672">.</span>sql<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;delete from overwatch_etl.jobRun_Silver where cast(Pipeline_SnapTS as date) &gt;= &#39;2020-12-31&#39; &#34;</span><span style="color:#f92672">)</span>
</code></pre></div><ol start="3">
<li>Delete from jobRun_gold table where Pipeline_SnapTS &gt;= &ldquo;2020-12-31&rdquo;</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">spark<span style="color:#f92672">.</span>sql<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;delete from overwatch_etl.jobRun_Gold where cast(Pipeline_SnapTS as date) &gt;= &#39;2020-12-31&#39; &#34;</span><span style="color:#f92672">)</span>
</code></pre></div><ol start="4">
<li>Update the Pipeline_Report table set Status = &ldquo;ROLLED_BACK&rdquo; where moduleId in (2011,3003) and status in (&lsquo;SUCCESS&rsquo;, &lsquo;EMPTY&rsquo;).
<ul>
<li>Modules 2011 and 3003 are the Silver and Gold modules for jobRun respectively</li>
<li>Only for Status values of &lsquo;SUCCESS&rsquo; and &lsquo;EMPTY&rsquo; because we want to maintain any &lsquo;FAILED&rsquo; or &lsquo;ERROR&rsquo; statuses that may be present from other runs</li>
</ul>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">spark<span style="color:#f92672">.</span>sql<span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;update overwatch_etl.pipeline_report set status = &#39;ROLLED_BACK&#39; where moduleID in (2011,3003) and status in (&#39;SUCCESS&#39;, &#39;EMPTY&#39;) &#34;</span><span style="color:#f92672">)</span>
</code></pre></div><p>After performing the steps above, the next Overwatch run will load the data from 12-31 -&gt; current.

<div class="notices warning" ><p>If back-loading more than 60 days, you must override the default primordialDateString in the config. Additionally, depending
on data volume and cluster size, it may be best to only load 60 days at a time using the <em>maxDaysToLoad</em> config. This
allows for the data to be loaded in chunks. Not necessary, but may have benefits depending on the situation.</p>
</div>
</p>

<div class="notices note" ><p>For smaller, dimensional, silver/gold entities and testing, it&rsquo;s often easier to just drop the table than 
it is to delete records after some date. <strong>Remember</strong>, though, it&rsquo;s critical to set the primordialDateString from time if 
rebuilding entities with more than 60 days.</p>
</div>

<h3 id="reloading-spark-data-silver">Reloading Spark Data (Silver)</h3>
<p>For performance reasons, there&rsquo;s one more update that must be made when reloading Spark Silver data. This data is 
derived from a VERY large events table, <em>overwatch_etl.spark_events_bronze</em>. To improve standard run performance,
new data that hasn&rsquo;t been processed is placed into it&rsquo;s own partition <em>Downstream_Processed = false&quot;</em>.</p>
<p>To set the <em>Downstream_Processed</em> flag to false for the correct records you must commit an update statement to the 
spark_events_bronze table as well before attempting to reload. This table is further partitions by &ldquo;Event&rdquo;; thus, the 
spark events to be reloaded can be further narrowed down with an Event filter. A map of spark entity to relevant 
events is provided below.</p>
<table>
<thead>
<tr>
<th style="text-align:left">SparkGoldEntity</th>
<th style="text-align:left">In Clause</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">sparkExecutions</td>
<td style="text-align:left">(&lsquo;org.apache.spark.sql.execution.ui.SparkListenerSQLExecutionStart&rsquo;, &lsquo;org.apache.spark.sql.execution.ui.SparkListenerSQLExecutionEnd&rsquo;)</td>
</tr>
<tr>
<td style="text-align:left">sparkJob</td>
<td style="text-align:left">(&lsquo;SparkListenerJobStart&rsquo;, &lsquo;SparkListenerJobEnd&rsquo;)</td>
</tr>
<tr>
<td style="text-align:left">sparkStage</td>
<td style="text-align:left">(&lsquo;SparkListenerStageSubmitted&rsquo;, &lsquo;SparkListenerStageCompleted&rsquo;)</td>
</tr>
<tr>
<td style="text-align:left">sparkTask</td>
<td style="text-align:left">(&lsquo;SparkListenerTaskStart&rsquo;, &lsquo;SparkListenerTaskEnd&rsquo;)</td>
</tr>
<tr>
<td style="text-align:left">sparkExecutor</td>
<td style="text-align:left">(&lsquo;SparkListenerExecutorAdded&rsquo;, &lsquo;SparkListenerExecutorRemoved&rsquo;)</td>
</tr>
</tbody>
</table>
<p>For another scenario, let&rsquo;s assume that the above steps have been completed but instead of jobRun, the sparkTasks
entity must be reloaded after 12-31. Unfortunately this table (spark_events_bronze) has not yet been partitioned by date
and the data volume for sparkTasks can be substantial. The best we can do in this scenario is to execute the statement
below and just wait. The more filters you can apply, the more efficient the reload will be, but don&rsquo;t be deceived, 
this is a raw table and many columns like &ldquo;timestamp&rdquo; you may expect to be populated often is not in all cases. Safe
filter columns include:</p>
<ul>
<li>Event (Must filter on this)</li>
<li>Pipeline_SnapTS</li>
<li>filenameGroup</li>
<li>clusterId</li>
<li>SparkContextId</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> updateStatement <span style="color:#66d9ef">=</span>
  <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    |update overwatch_etl.spark_events_bronze set Downstream_Processed = false
</span><span style="color:#e6db74">    | where Event in (&#39;SparkListenerTaskStart&#39;, &#39;SparkListenerTaskEnd&#39;)
</span><span style="color:#e6db74">    | and cast(Pipeline_SnapTS as date) &gt;= &#39;2020-12-31&#39;
</span><span style="color:#e6db74">    |&#34;&#34;&#34;</span><span style="color:#f92672">.</span>stripMargin
spark<span style="color:#f92672">.</span>sql<span style="color:#f92672">(</span>updateStatement<span style="color:#f92672">)</span>
</code></pre></div><h3 id="running-only-specific-layers">Running Only Specific Layers</h3>
<p>As in the example above, it&rsquo;s common to need to rerun only a certain layer for testing or reloading data. In the 
example above it&rsquo;s inefficient to run the bronze layer repeatedly to reprocess two tables in silver and gold. If 
no new data is ingested into bronze, no modules outside of the two we rolled_back will have any new data and thus
will essentially be skipped resulting in the re-processing of only the two tables we&rsquo;re working on.</p>
<p>The main class entrypoint for Overwatch runs all layers and there&rsquo;s no way around this. To run only specific layers
a notebook can be used. Build the config as normal, and then following the instructions in 
<a href="https://databrickslabs.github.io/overwatch/gettingstarted/#run-via-notebook">Getting Started - Run Via Notebook</a>. This example illustrates how 
to run each of the three layers; Bronze, Silver, and Gold. In this scenario the Bronze(&hellip;) line would be commented
out to result in only a Silver/Gold layer run.</p>
<h2 id="cloud-specific-variations">Cloud-Specific Variations</h2>


<footer class="footline">
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="https://databrickslabs.github.io/overwatch/dataengineer/definitions/" title="Definitions"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="https://databrickslabs.github.io/overwatch/dataengineer/upgrade/" title="Upgrade" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://databrickslabs.github.io/overwatch/js/clipboard.min.js?1624455023"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/perfect-scrollbar.min.js?1624455023"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/perfect-scrollbar.jquery.min.js?1624455023"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/jquery.sticky.js?1624455023"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/featherlight.min.js?1624455023"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/highlight.pack.js?1624455023"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://databrickslabs.github.io/overwatch/js/modernizr.custom-3.6.0.js?1624455023"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/learn.js?1624455023"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/hugo-learn.js?1624455023"></script>

    <link href="https://databrickslabs.github.io/overwatch/mermaid/mermaid.css?1624455023" rel="stylesheet" />
    <script src="https://databrickslabs.github.io/overwatch/mermaid/mermaid.js?1624455023"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

