<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.108.0">
    <meta name="description" content="Overwatch Documentation">
<meta name="author" content="Daniel Tomes -- DatabricksLabs">

    <link rel="icon" href="https://databrickslabs.github.io/overwatch/images/favicon.png" type="image/png">

    <title>AdvancedTopics :: Overwatch</title>

    
    <link href="https://databrickslabs.github.io/overwatch/css/nucleus.css?1680128264" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/fontawesome-all.min.css?1680128264" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/hybrid.css?1680128264" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/featherlight.min.css?1680128264" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/perfect-scrollbar.min.css?1680128264" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/auto-complete.css?1680128264" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/atom-one-dark-reasonable.css?1680128264" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/theme.css?1680128264" rel="stylesheet">
    <link href="https://databrickslabs.github.io/overwatch/css/hugo-theme.css?1680128264" rel="stylesheet">
    
    <link href="https://databrickslabs.github.io/overwatch/css/theme-blue.css?1680128264" rel="stylesheet">
    
    

    <script src="https://databrickslabs.github.io/overwatch/js/jquery-3.3.1.min.js?1680128264"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    

<script async defer src="https://buttons.github.io/buttons.js"></script>
  </head>
  <body class="" data-url="https://databrickslabs.github.io/overwatch/dataengineer/advancedtopics/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://databrickslabs.github.io/overwatch/">
    <img src="https://databrickslabs.github.io/overwatch/images/tmp_logo4.png", width="85%">
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="https://databrickslabs.github.io/overwatch/js/lunr.min.js?1680128264"></script>
<script type="text/javascript" src="https://databrickslabs.github.io/overwatch/js/auto-complete.js?1680128264"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/databrickslabs.github.io\/overwatch\/";
    
</script>
<script type="text/javascript" src="https://databrickslabs.github.io/overwatch/js/search.js?1680128264"></script>

    
  </div>
  
  <section id="homelinks">
    <ul>
      <li>
        <a class="padding" href='https://databrickslabs.github.io/overwatch/'><i class='fas fa-home'></i> Home</a>
      </li>
    </ul>
  </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/deployoverwatch/" title="Deploy Overwatch" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/">
          Deploy Overwatch
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/deployoverwatch/cloudinfra/" title="Cloud Infrastructure" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/cloudinfra/">
          Cloud Infrastructure
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/cloudinfra/azure/" title="Azure" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/cloudinfra/azure/">
        Azure
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/cloudinfra/aws/" title="AWS" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/cloudinfra/aws/">
        AWS
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/deployoverwatch/configureoverwatch/" title="Configure Overwatch" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/configureoverwatch/">
          Configure Overwatch
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/configureoverwatch/configuration/" title="Configuration" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/configureoverwatch/configuration/">
        Configuration
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/configureoverwatch/customcosts/" title="Custom Costs" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/configureoverwatch/customcosts/">
        Custom Costs
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/configureoverwatch/securityconsiderations/" title="Security Considerations" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/configureoverwatch/securityconsiderations/">
        Security Considerations
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/configureoverwatch/validation/" title="Validation" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/configureoverwatch/validation/">
        Validation
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/configureoverwatch/configurationlegacy/" title="Configuration (Legacy)" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/configureoverwatch/configurationlegacy/">
        Configuration (Legacy)
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/deployoverwatch/runningoverwatch/" title="Running Overwatch" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/runningoverwatch/">
          Running Overwatch
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/runningoverwatch/clusterconfig/" title="Cluster Configuration" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/runningoverwatch/clusterconfig/">
        Cluster Configuration
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/runningoverwatch/notebook/" title="As A Notebook" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/runningoverwatch/notebook/">
        As A Notebook
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/runningoverwatch/jar/" title="As A JAR" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/runningoverwatch/jar/">
        As A JAR
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/runningoverwatch/notebooklegacy/" title="As A Notebook (Legacy)" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/runningoverwatch/notebooklegacy/">
        As A Notebook (Legacy)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/runningoverwatch/jarlegacy/" title="As A JAR (Legacy)" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/runningoverwatch/jarlegacy/">
        As A JAR (Legacy)
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/deployoverwatch/sharingoverwatch/" title="Sharing Overwatch Data" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/sharingoverwatch/">
        Sharing Overwatch Data
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/dataengineer/" title="Data Engineering" class="dd-item
        parent
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/dataengineer/">
          Data Engineering
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/dataengineer/definitions/" title="Data Dictionary (Latest)" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/dataengineer/definitions/">
          Data Dictionary (Latest)
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/dataengineer/definitions/061x/" title="Data Dictionary - 0.6.1.x" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/dataengineer/definitions/061x/">
        Data Dictionary - 0.6.1.x
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dataengineer/modules/" title="Modules / Scopes" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/dataengineer/modules/">
        Modules / Scopes
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dataengineer/pipeline_management/" title="Pipeline_Management" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/dataengineer/pipeline_management/">
        Pipeline_Management
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dataengineer/upgrade/" title="Upgrades" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/dataengineer/upgrade/">
        Upgrades
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dataengineer/productionizing/" title="Productionizing" class="dd-item ">
        <a href="https://databrickslabs.github.io/overwatch/dataengineer/productionizing/">
        Productionizing
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/dataengineer/advancedtopics/" title="AdvancedTopics" class="dd-item active">
        <a href="https://databrickslabs.github.io/overwatch/dataengineer/advancedtopics/">
        AdvancedTopics
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/changelog/" title="ChangeLog" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/changelog/">
          ChangeLog
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/faq/" title="FAQ" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/faq/">
          FAQ
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/troubleshooting/" title="Troubleshooting" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/troubleshooting/">
          Troubleshooting
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/contributing/" title="" class="dd-item
        
        
        
        ">
      <a href="https://databrickslabs.github.io/overwatch/contributing/">
          
          
      </a>
      
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="footer">
      <center>

    
    <a class="github-button" href="https://github.com/databrickslabs/overwatch/subscription"
       data-icon="octicon-eye" data-show-count="true" aria-label="Watch Overwatch on GitHub">Watch</a>


    <a class="github-button" href="https://github.com/databrickslabs/overwatch" data-icon="octicon-star" data-show-count="true" aria-label="Star databrickslabs/overwatch on GitHub">Star</a>


    <a class="github-button" href="https://github.com/databrickslabs/overwatch/fork"
       data-icon="octicon-repo-forked" data-show-count="true" aria-label="Fork Overwatch on GitHub">Fork</a>

    <p>A <a href="https://www.databricks.com/learn/labs">Databricks Labs</a> project.</p>
</center>

<script async defer src="https://buttons.github.io/buttons.js"></script>
    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='https://databrickslabs.github.io/overwatch/'>Welcome To OverWatch</a> > <a href='https://databrickslabs.github.io/overwatch/dataengineer/'>Data Engineering</a> > AdvancedTopics
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#quick-reference">Quick Reference</a></li>
    <li><a href="#optimizing-overwatch">Optimizing Overwatch</a>
      <ul>
        <li><a href="#optimization-limitations-bronze">Optimization Limitations (Bronze)</a></li>
        <li><a href="#utilize-external-optimizeexternalize-optimize--z-order-as-of-060">Utilize <a href="#externalize-optimize--z-order-as-of-060">External Optimize</a></a></li>
        <li><a href="#additional-optimization-considerations">Additional Optimization Considerations</a></li>
      </ul>
    </li>
    <li><a href="#using-external-metastores">Using External Metastores</a></li>
    <li><a href="#externalize-optimize--z-order-as-of-060">Externalize Optimize &amp; Z-Order (as of 0.6.0)</a></li>
    <li><a href="#interacting-with-overwatch-and-its-state">Interacting With Overwatch and its State</a>
      <ul>
        <li><a href="#instantiating-the-workspace">Instantiating the Workspace</a></li>
        <li><a href="#using-the-workspace">Using the Workspace</a></li>
      </ul>
    </li>
    <li><a href="#getting-a-strong-first-run">Getting a Strong First Run</a>
      <ul>
        <li><a href="#test-first">Test First</a></li>
        <li><a href="#historical-loading">Historical Loading</a></li>
        <li><a href="#empty--test--poc-workspaces-arent-a-valid-test">Empty / Test / POC workspaces Aren&rsquo;t A Valid Test</a></li>
      </ul>
    </li>
    <li><a href="#cluster-logs-ingest-details">Cluster Logs Ingest Details</a>
      <ul>
        <li><a href="#cluster-logs-loading-scenarios">Cluster Logs Loading Scenarios</a></li>
        <li><a href="#exception---remote-workspaces-with-50-mounts">Exception - Remote Workspaces With 50+ Mounts</a></li>
      </ul>
    </li>
    <li><a href="#joining-with-slow-changing-dimensions-scd">Joining With Slow Changing Dimensions (SCD)</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              AdvancedTopics
            </h1>
          

        


<h2 id="quick-reference">Quick Reference</h2>
<ul>
<li><a href="#externalize-optimize--z-order-as-of-060">Externalize Optimize &amp; Z-Order</a></li>
<li><a href="#interacting-with-overwatch-and-its-state">Interacting With Overwatch and its State</a></li>
<li><a href="#optimizing-overwatch">Optimizing Overwatch</a></li>
<li><a href="#getting-a-strong-first-run">Maximizing First Run Potential</a>
<ul>
<li><a href="#historical-loading">Historical Loads</a></li>
</ul>
</li>
<li><a href="#cluster-logs-ingest-details">Cluster Logs Ingest Details</a></li>
<li><a href="#joining-with-slow-changing-dimensions-scd">Joining With Slow Changing Dimensions (SCD)</a></li>
</ul>
<h2 id="optimizing-overwatch">Optimizing Overwatch</h2>
<p><strong>Expectation Check</strong> Note that Overwatch analyzes nearly all aspects of the Workspace and manages its own pipeline
among many other tasks. This results in 1000s of spark job executions and as such, the Overwatch job will take some
time to run. For small/medium workspaces, 20-40 minutes should be expected for each run. Larger workspaces can take
longer, depending on the size of the cluster, the Overwatch configuration, and the workspace.</p>
<p>The optimization tactics discussed below are aimed at the &ldquo;large workspace&rdquo;; however, many can be applied to
small / medium workspaces.</p>
<p><strong>Large Workspace</strong> is generally defined &ldquo;large&rdquo; due to one or more of the following factors</p>
<ul>
<li>250+ clusters created / day &ndash; common with external orchestrators such as airflow, when pools are heavily used,
and many other reasons</li>
<li>All clusters logging and 5000+ compute hours / day</li>
</ul>
<h3 id="optimization-limitations-bronze">Optimization Limitations (Bronze)</h3>
<p>Note that there are two modules that simply cannot be linearly parallelized for reasons beyond the scope of this
write-up. These limiting factors are only present in Bronze and thus one optimization is to utilize one cluster
spec for bronze and another for silver/gold. To do this, utilize Databricks&rsquo; <a href="https://databricks.com/blog/2021/07/13/announcement-orchestrating-multiple-tasks-with-databricks-jobs-public-preview.html">multi-task jobs feature</a>
to run into three steps and specify two cluster. To split the Overwatch Pipeline into bronze/silver/gold steps
refer to the <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/runningoverwatch/jarlegacy//#via-main-class">Main Class Setup Configuration</a></p>
<ul>
<li>Bronze - small static (no autoscaling) cluster to trickle load slow modules</li>
<li>Silver/Gold - slightly larger (autoscaling enabled as needed) - cluster to blaze through the modules as
silver and gold modules are nearly linearly scalable. Overwatch developers will continue to strive for linear
scalability in silver/gold.</li>
</ul>
<p>Below is a screenshot illustrating the job definition when broken apart into a multi-task job.
<img src="https://databrickslabs.github.io/overwatch/images/GettingStarted/AdvancedTopics/Overwatch_multitaskJob.png" alt="Multi-TaskJob"></p>
<h3 id="utilize-external-optimizeexternalize-optimize--z-order-as-of-060">Utilize <a href="#externalize-optimize--z-order-as-of-060">External Optimize</a></h3>
<p>Externalizing the optimize and z-order functions is critical for reducing daily Overwatch runtimes and increasing
efficiency of the optimize and z-order functions. Optimize &amp; z-order are more efficient the larger the dataset and
the larger the number of partitions to be optimized. Furthermore, optimize functions are very parallelizable and
thus should be run on a larger, autoscaling cluster. Lastly, by externalizing the optimize functions, this task only
need be carried out on a single workspace per Overwatch output target (i.e. storage prefix target).</p>
<h3 id="additional-optimization-considerations">Additional Optimization Considerations</h3>
<ul>
<li>As of 0.7.0 Use DBR 11.3 LTS
<ul>
<li>Photon can significantly improve runtimes. Mileage will vary by customer depending on data sizes and skews of
certain modules, so feel free to turn it on and use Overwatch to determine whether Photon is the right answer for
your needs.</li>
</ul>
</li>
<li>As of 0.6.1 disable Photon
<ul>
<li>Photon will be the focus of optimization in DBR 11.xLTS+</li>
</ul>
</li>
<li>0.6.1+ Use DBR 10.4 LTS</li>
<li>&lt; 0.6.1 Use DBR 9.1 LTS
<ul>
<li>This is critical as there are some regressions in 10.4LTS that have been handled in Overwatch 0.6.1 but not
in previous versions</li>
</ul>
</li>
<li>(Azure) Follow recommendations for Event Hub. If using less than 32 partitions, increase this immediately.
<ul>
<li>If workspace is VERY large or has 50+ concurrent users, suggest increasing <code>minEventsPerTrigger</code> in the audit
log config. This is defaulted to 10, increase it to 100+. TLDR, this is the minimum number of events in Event Hub
allowed before Overwatch will progress past the audit log events module. If the workspace is generating more than 10
events faster than Overwatch can complete the streaming batch then the module may never complete or may get stuck
here for some time.</li>
<li>Consider increasing <code>maxEventsPerTrigger</code> from default of 10000 to 50000 to load more audit logs per batch. This
will only help if there are 10K+ audit events per day on the workspace.</li>
</ul>
</li>
<li>Ensure direct networking routes are used between storage and compute and that they are in the same region
<ul>
<li>Overwatch target can be in separate region for multi-region architectures but sources should be co-located with
compute.</li>
</ul>
</li>
</ul>
<h2 id="using-external-metastores">Using External Metastores</h2>
<p>If you&rsquo;re using an external metastore for your workspaces, pay close attention to the Database Paths configured in
the <em>DataTarget</em>. Notice that the <strong>workspaceID</strong> has been removed for the external metastore in the db paths. This
is because when using internal metastores and creating databases in multiple workspaces you are actually creating
different instances of databases with the same name; conversely, when you use an external metastore, the database truly
is the same and will already exist in subsequent workspaces. This is why we remove the workspaceID from the path
so that the one instance of the database truly only has one path, not one per workspace.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#75715e">// DEFAULT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> dataTarget <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">DataTarget</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span>etlDB<span style="color:#f92672">),</span> <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;</span><span style="color:#e6db74">${</span>storagePrefix<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>workspaceID<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>etlDB<span style="color:#e6db74">}</span><span style="color:#e6db74">.db&#34;</span><span style="color:#f92672">),</span> <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;</span><span style="color:#e6db74">${</span>storagePrefix<span style="color:#e6db74">}</span><span style="color:#e6db74">/global_share&#34;</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span>consumerDB<span style="color:#f92672">),</span> <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;</span><span style="color:#e6db74">${</span>storagePrefix<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>workspaceID<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>consumerDB<span style="color:#e6db74">}</span><span style="color:#e6db74">.db&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// EXTERNAL METASTORE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> dataTarget <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">DataTarget</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span>etlDB<span style="color:#f92672">),</span> <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;</span><span style="color:#e6db74">${</span>storagePrefix<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>etlDB<span style="color:#e6db74">}</span><span style="color:#e6db74">.db&#34;</span><span style="color:#f92672">),</span> <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;</span><span style="color:#e6db74">${</span>storagePrefix<span style="color:#e6db74">}</span><span style="color:#e6db74">/global_share&#34;</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span>consumerDB<span style="color:#f92672">),</span> <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;</span><span style="color:#e6db74">${</span>storagePrefix<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>consumerDB<span style="color:#e6db74">}</span><span style="color:#e6db74">.db&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span></code></pre></div><h2 id="externalize-optimize--z-order-as-of-060">Externalize Optimize &amp; Z-Order (as of 0.6.0)</h2>
<p>The Overwatch pipeline has always included the Optimize &amp; Z-Order functions. By default all targets are set to
be optimized once per week which resulted in very different runtimes once per week.
As of 0.6.0, this can be removed from the Overwatch Pipeline (i.e. externalized).
Reasons to externalize include:</p>
<ul>
<li>Lower job runtime variability and/or improve consistency to hit SLAs</li>
<li>Utilize a more efficient cluster type/size for the optimize job
<ul>
<li>Optimize &amp; Zorder are extremely efficient but do heavily depend on local storage; thus Storage Optimized compute
nodes are highly recommended for this type of workload.
<ul>
<li>Azure: Standard_L*s series</li>
<li>AWS: i3.*xLarge</li>
</ul>
</li>
</ul>
</li>
<li>Allow a single job to efficiently optimize Overwatch for all workspaces
<ul>
<li>Note that the scope of &ldquo;all workspaces&rdquo; above is within the scope of a data target. All workspaces that send
data to the same dataset can be optimized from a single workspace.</li>
</ul>
</li>
</ul>
<p>To externalize the optimize and z-order tasks:</p>
<ul>
<li>Set <em>externalizeOptimize</em> to true in the runner notebook config (All Workspaces)
<ul>
<li>If running as a job don&rsquo;t forget to update the job parameters with the new escaped JSON config string</li>
</ul>
</li>
<li>Create a job to execute the optimize on the workspace you wish (One Workspace - One Job)
<ul>
<li>Type: JAR</li>
<li>Main Class: <code>com.databricks.labs.overwatch.Optimizer</code></li>
<li>Dependent Libraries: <code>com.databricks.labs:overwatch_2.12:&lt;LATEST&gt;</code></li>
<li>Parameters: <code>[&quot;&lt;Overwatch_etl_database_name&gt;&quot;]</code></li>
<li>Cluster Config: Recommended
<ul>
<li>DBR Version: 11.3LTS</li>
<li>Photon: Optional</li>
<li>Enable Autoscaling Compute with enough nodes to go as fast as you want. 4-8 is a good starting point</li>
<li>AWS &ndash; Enable autoscaling local storage</li>
<li>Worker Nodes: Storage Optimize</li>
<li>Driver Node: General Purpose with 16+ cores
<ul>
<li>The driver gets very busy on these workloads - recommend 16 - 64 cores depending on the max size of the cluster</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://databrickslabs.github.io/overwatch/images/GettingStarted/AdvancedTopics/optimizerJob.png" alt="OptimizeJob"></p>
<h2 id="interacting-with-overwatch-and-its-state">Interacting With Overwatch and its State</h2>
<p>Use your production notebook (or equivallent) to instantiate your Overatch Configs.
From there use <code>JsonUtils.compactString</code> to get the condensed parameters for your workspace.</p>
<p><strong>NOTE</strong> you cannot use the escaped string, it needs to be the compactString.</p>
<p>Below is an example of getting the compact string. You may also refer to the
<a href="https://databrickslabs.github.io/overwatch/gettingstarted/#initializing-the-environment">example runner notebook</a>
for your cloud provider.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">val</span> params <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">OverwatchParams</span><span style="color:#f92672">(...)</span>
</span></span><span style="display:flex;"><span>print<span style="color:#f92672">(</span><span style="color:#a6e22e">JsonUtils</span><span style="color:#f92672">.</span>objToJson<span style="color:#f92672">(</span>params<span style="color:#f92672">).</span>compactString<span style="color:#f92672">)</span>
</span></span></code></pre></div><h3 id="instantiating-the-workspace">Instantiating the Workspace</h3>
<p><strong>As Of 0.6.0.4</strong> Utilize Overwatch Helper functions get the workspace object for you. The workspace object returned
will be the Overwatch config and state of the current workspace at the time of the last successful run.

<div class="notices note" ><p>As of 0.6.1 this helper function is not expected to work across versions, meaning that if the last run was on
0.6.0.4 and the 0.6.1 JAR is attached, don&rsquo;t expect this method to work</p>
</div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> com.databricks.labs.overwatch.utils.Helpers
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">val</span> prodWorkspace <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Helpers</span><span style="color:#f92672">.</span>getWorkspaceByDatabase<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;overwatch_etl&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// for olderVersions use the compact String
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// import com.databricks.labs.overwatch.pipeline.Initializer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Get the compactString from the runner notebook you used for your first run example BE SURE your configs are the same as they are in prod
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// val workspace = Initializer(&#34;&#34;&#34;&lt;compact config string&gt;&#34;&#34;&#34;)
</span></span></span></code></pre></div><h3 id="using-the-workspace">Using the Workspace</h3>
<p>Now that you have the workspace you can interact with Overwatch very intuitively.</p>
<h4 id="exploring-the-config">Exploring the Config</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>prodWorkspace<span style="color:#f92672">.</span>getConfig<span style="color:#f92672">.*</span>
</span></span></code></pre></div><p>After the last period in the command above, push tab and you will be able to see the entire
derived configuratin and it&rsquo;s state.</p>
<h4 id="interacting-with-the-pipeline">Interacting with the Pipeline</h4>
<p>When you instantiate a pipeline you can get stateful Dataframes, modules, and their configs such as the timestamp
from which a DF will resume, etc.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">val</span> bronzePipeline <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Bonze</span><span style="color:#f92672">(</span>prodWorkspace<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">val</span> silverPipeline <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Silver</span><span style="color:#f92672">(</span>prodWorkspace<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">val</span> goldPipeline <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Gold</span><span style="color:#f92672">(</span>prodWorkspace<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>bronzePipeline<span style="color:#f92672">.*</span>
</span></span></code></pre></div><p>Instantiating a pipeline gives you access to its public methods.
Doing this allows you to navigate the pipeline and its state very naturally</p>
<h4 id="using-targets">Using Targets</h4>
<p>A &ldquo;target&rdquo; is essentially an Overwatch-defined table with a ton of helper methods and attributes. The attributes
are closed off in 0.5.0 but <a href="https://github.com/databrickslabs/overwatch/issues/164">Issue 164</a> will expose all
reasonably helpful attributes making the target definition even more powerful.</p>
<p>Note that the scala filter method below will be simplified in upcoming release, referenced in
<a href="https://github.com/databrickslabs/overwatch/issues/166">Issue 166</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">val</span> bronzeTargets <span style="color:#66d9ef">=</span> bronzePipeline<span style="color:#f92672">.</span>getAllTargets
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">val</span> auditLogTarget <span style="color:#66d9ef">=</span> bronzeTargets<span style="color:#f92672">.</span>filter<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>name <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;audit_log_bronze&#34;</span><span style="color:#f92672">)</span> <span style="color:#75715e">// the name of a target is the name of the etl table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// a workspace level dataframe of the table. It&#39;s workspace-level because &#34;global filters&#34; are automatically 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// applied by defaults which includes your workspace id, thus this will return the dataframe of the audit logs 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// for this workspace
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> auditLogWorkspaceDF <span style="color:#66d9ef">=</span> auditLogTarget<span style="color:#f92672">.</span>asDF<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// If you want to get the global dataframe
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> auditLogGlobalDF <span style="color:#66d9ef">=</span> auditLogTarget<span style="color:#f92672">.</span>asDF<span style="color:#f92672">(</span>withGlobalFilters <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><h2 id="getting-a-strong-first-run">Getting a Strong First Run</h2>
<p>The first run is likely the most important as it initializes all the slow-changing dimensions and sets the stage for
subsequent runs. Follow the steps below to get a strong start.</p>
<h3 id="test-first">Test First</h3>
<p>Let&rsquo;s test before trying to dive right into loading a year+ of historical data. Set the primordial date to today -
5 days and run the pipeline. Then review the pipReport:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>display<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>  table<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;overwatch_etl.pipReport&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>orderBy<span style="color:#f92672">(</span>&#39;Pipeline_SnapTS<span style="color:#f92672">.</span>desc<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>and validate that all the modules are operating as expected. Once you&rsquo;re certain all the modules are executing
properly, <a href="https://databrickslabs.github.io/overwatch/faq//##q1-how-to-clean-re-deploy">run a full cleanup</a> and update the parameters to load
historical data and begin your production deployment.</p>
<h3 id="historical-loading">Historical Loading</h3>
<p>Recommended max historical load is 30 days on AWS and 7 days on Azure.</p>
<p><strong>DISABLE SPOT INSTANCES</strong> &ndash; when loading historical data, the last thing you want is to get nearly complete
loading non-splittable sources just to have the node killed to spot instance termination and have to restart the process.
It&rsquo;s likely more expensive to try and complete your first run with spot instances enabled. This may also be true in
production daily runs but it determines on your spot market availability and how often nodes are reclaimed during
your daily run.</p>
<p>If you&rsquo;re in AWS and planning to load a year of historical data because you have the audit logs to warrant it, that&rsquo;s
great but note that several of the critical APIs such as clusterEvents and sqlQueryHistory don&rsquo;t store data for that
long. ClusterEvents in particular is key for calculating utilization and costs; thus you need to determine if the
historical data you&rsquo;re going to get is really worth loading all of this history. Additionally, sparkEvents will only
load so much history based on cluster log availability and will likely not load logs for historically transient clusters
since Overwatch will look for the clusterEvents, they will be missing for a jobs cluster from 6 months ago and Overwatch
will determine there&rsquo;s no activity on the cluster and not scan its directories.</p>
<p>Lastly, note that several of the sources in bronze aren&rsquo;t highly parallelizable due to their sources; this means that
throwing more compute at this problem will only provide limited benefits.</p>
<h3 id="empty--test--poc-workspaces-arent-a-valid-test">Empty / Test / POC workspaces Aren&rsquo;t A Valid Test</h3>
<p>If most of your scopes are empty (i.e. you&rsquo;ve never run any jobs and only have 1 cluster without logging enabled) most
of the modules will be skipped and provide no insight as to if Overwatch is configured correctly for production.</p>
<h2 id="cluster-logs-ingest-details">Cluster Logs Ingest Details</h2>
<p>For Overwatch to load the right-side of the ERD (Spark UI) the compute that executes the Spark Workloads must
have cluster logging enabled and Overwatch must be able to load these logs. To do this, Overwatch uses its own data to
determine the logging locations of all clusters and identifies clusters that have created logs within the Pipeline
run&rsquo;s time window (i.e. Jan 1 2023 &ndash;&gt; Jan 2 2023).</p>
<p>Historically (legacy deployments), this was fairly simple as all the logging locations were generally accessible
from the workspace on which Overwatch Pipeline was running (since there was one Overwatch Pipeline on each
workspace). There was massive demand to enable remote workspace monitoring such that Overwatch is only needed to be
deployed on a single workspace and can monitor one or many local/remote workspaces from a centralized location.</p>
<p>As a result of this, the security requirements became a bit more involved to ensure the Overwatch cluster has access
to all the storage where clusters persist their logs. An Overwatch cluster on workspace 1 cannot simply access
logs on workspace 2 at some mounted location since the mounted location on workspace 2 may actually map to a different
target than it does on workspace 1. To solve this, Overwatch uses a &ldquo;search-mounts&rdquo; api to translate remote mounts to
fully-qualified storage paths; as such the Overwatch cluster must be authorized to directly access the fully-qualified
storage path hence the need for additional security authorizations. If this is not something that is possible for your
organization, you may still use the new deployment method and simply deploy Overwatch on each workspace similar to
the traditional method and nothing changes.</p>
<p><strong>For AWS</strong> &ndash; ensure the Overwatch cluster has access to the remote s3:// paths to which clusters log</p>
<p><strong>For Azure</strong> &ndash; An SPN should be provisioned and authorized to read to all abfss:// storage accounts / containers to
which cluters log.
See <a href="https://databrickslabs.github.io/overwatch/deployoverwatch/configureoverwatch/securityconsiderations//#azure-storage-auth-config">Security Consideration</a>
for more details on how to add the SPN configuration to the Overwatch Cluster..</p>
<h3 id="cluster-logs-loading-scenarios">Cluster Logs Loading Scenarios</h3>
<p>Examples often help simplify complex details so let&rsquo;s examine some scenarios. Given that Workspace 123 is where
Overwatch is deployed and you would like to monitor workspaces 123 and 456 with Overwatch from the single 123
deployment. You deploy Overwatch on Workspace 123 and configure 456 as a remote but now you need to figure out
how to get cluster on workspace 123 to access all the storage in the remote workspace[s]. This is where some
governance and cluster policies come in handy &ndash; if you&rsquo;re organization is already forcing clusters to log to a
limited number of storage accounts / buckets then provisioning access here isn&rsquo;t too difficult.</p>
<p>The image below illustrates how the traffic flows along with several notes about how cluster log acquisition works
for local and remote workspaces.
<img src="https://databrickslabs.github.io/overwatch/images/DataEngineer/Overwatch_Cluster_Log_Acquisition.png" alt="ClusterLogAcquisitionDiagram"></p>
<p>Given the above diagram and a cluster logging path, below is a table of access scenarios. Notice the
&ldquo;Overwatch Reads Logs From&rdquo; field which demonstrates from which path Overwatch will load the logs in the given
scenario; the Overwatch cluster must have access to read from that location.</p>
<table>
<thead>
<tr>
<th>Workspace</th>
<th>Cluster Logging Path</th>
<th>Is Mounted</th>
<th>Fully Qualified Storage Location</th>
<th>Accessible From Deployment Workspace</th>
<th>Overwatch Reads Logs From</th>
<th>Comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>123</td>
<td>dbfs:/mnt/cluster_logs (AWS)</td>
<td>True</td>
<td>s3://myCompany/logsBucket/123</td>
<td>True</td>
<td>dbfs:/mnt/cluster_logs</td>
<td>Locally mounted locations are directly accessed on deployment workspace</td>
</tr>
<tr>
<td>123</td>
<td>dbfs:/mnt/cluster_logs (Azure)</td>
<td>True</td>
<td>abfss://mylogsContainer123@myComany&hellip;</td>
<td>True</td>
<td>dbfs:/mnt/cluster_logs</td>
<td>Locally mounted locations are directly accessed on deployment workspace</td>
</tr>
<tr>
<td>123</td>
<td>dbfs:/unmounted_local_path</td>
<td>False</td>
<td>dbfs:/unmounted_local_path</td>
<td>True</td>
<td>dbfs:/unmounted_local_path</td>
<td>Locally mounted locations are directly accessed on deployment workspace</td>
</tr>
<tr>
<td>123</td>
<td>s3://myCompany/logsBucket/123 (AWS)</td>
<td>False</td>
<td>s3://myCompany/logsBucket/123</td>
<td>True*</td>
<td>s3://myCompany/logsBucket/123</td>
<td>AWS - Direct s3 path access as configured in cluster logs</td>
</tr>
<tr>
<td>456</td>
<td>dbfs:/mnt/cluster_logs (AWS)</td>
<td>True</td>
<td>s3://myCompany/logsBucket/456</td>
<td>True*</td>
<td>s3://myCompany/logsBucket/456</td>
<td>Remote mount point is translated to fully-qualified path and remote storage is access directly</td>
</tr>
<tr>
<td>456</td>
<td>dbfs:/mnt/cluster_logs (Azure)</td>
<td>True</td>
<td>abfss://mylogsContainer456@myComany&hellip;</td>
<td>True*</td>
<td>abfss://mylogsContainer456@myComany&hellip;</td>
<td>Remote mount point is translated to fully-qualified path and remote storage is access directly</td>
</tr>
<tr>
<td>456</td>
<td>dbfs:/unmounted_local_path</td>
<td>False</td>
<td>dbfs:/unmounted_local_path</td>
<td>False</td>
<td>Inaccessible</td>
<td>Root dbfs storage locations are never accessible from outside the workspace</td>
</tr>
<tr>
<td>456</td>
<td>s3://myCompany/logsBucket/456 (AWS)</td>
<td>False</td>
<td>s3://myCompany/logsBucket/456</td>
<td>True*</td>
<td>s3://myCompany/logsBucket/456</td>
<td>AWS - Direct s3 path access as configured in cluster logs</td>
</tr>
</tbody>
</table>
<p>* (AWS) Assuming Instance Profile authroized to the fully qualified path location and configured</p>
<p>* (AZURE) Assuming SPN authroized to the fully qualified path location and configured on the Overwatch cluster</p>
<h3 id="exception---remote-workspaces-with-50-mounts">Exception - Remote Workspaces With 50+ Mounts</h3>
<p>In the image above, you likely noticed the alert. As of version 0.7.1.1, Overwatch can handle remote workspaces
with more than 50 mounts through an alternative process.</p>
<p>When a remote workspace has &gt; 50 mounts and 1 or more clusters log to a mounted location, the following process must
be followed to acquire the logs for that path.</p>
<h4 id="remote-workspaces-with-50-mounts-config-process">Remote Workspaces With 50+ Mounts Config Process</h4>
<p>The process below will allow you to bypass the API limitation and manually acquire all the mounts and their maps for
a workspace as a CSV. Upload this to an accessible location on the deployment workspace (i.e. Workspace 123) and add
it to the configuration for that workspace.</p>
<p>Continuing the example from above, if Workspace 456 had &gt; 50 mounts</p>
<ul>
<li>Log into the remote workspace (Workspace 456)</li>
<li>Import and Execute this Notebook <strong><a href="https://databrickslabs.github.io/overwatch/assets/DataEngineer/071x_Remote_Log_Mapping.html">HTML</a> | <a href="https://databrickslabs.github.io/overwatch/assets/DataEngineer/071x_Remote_Log_Mapping.dbc">DBC</a></strong></li>
<li>Follow instruction in the notebook to download the results as CSV.
<ul>
<li>Download the results (all of them &ndash; follow closely if &gt; 1000 mounts)</li>
<li>Name the file something meaningful so you know it corresponds to Workspace 456 (i.e. mounts_mapping_456.csv)</li>
</ul>
</li>
<li>Upload to accessible location in deployment workspace (Workspace 123) such as dbfs:/Filestore/overwatch/mounts_mapping_456.csv</li>
<li>Add the path to the <strong>mount_mapping_path</strong> in the
<a href="https://databrickslabs.github.io/overwatch/deployoverwatch/configureoverwatch/configuration//#column-description">multi-workspace config</a>.</li>
</ul>
<p><strong>Download Screenshot Example</strong> If more than 1000 mounts use follow the screenshot exactly otherwise just hit the
down arrow to download
<img src="https://databrickslabs.github.io/overwatch/images/DataEngineer/mounts_download.png" alt="ClusterLogAcquisitionDiagram"></p>
<p>Now Overwatch can bypass the API limitation of only being able to access 50 mounts for this remote workspace.
Repeat this process for all workspaces that have &gt;50 mounts. Leave the <em>&ldquo;mount_mapping_path&rdquo;</em> emtpy for the workspaces
that do not have &gt;50 mounts and Overwatch will use the api to automatically map the mount points to
fully-qualified storage paths for you.</p>
<p><strong>WHY SO COMPLICATED</strong>
The Databricks API does not support pagination and will only return a max of 50 results. This process is meant as a
work-around method until Databricks can update this API to support higher max results, filters, and/or pagination at
which time the subsequent release of Overwatch will omit this complexity.</p>
<h2 id="joining-with-slow-changing-dimensions-scd">Joining With Slow Changing Dimensions (SCD)</h2>
<p>The nature of time throughout the Overwatch project has resulted in the need to for
advanced time-series DataFrame management. As such, a vanilla version of
<a href="https://github.com/databrickslabs/tempo">databrickslabs/tempo</a> was implemented
for the sole purpose of enabling Scala time-series DataFrames (TSDF). TSDFs enable
&ldquo;asofJoin&rdquo; and &ldquo;lookupWhen&rdquo; functions that also efficiently handle massive skew as is
introduced with the partitioning of organization_id and cluster_id. Please refer to the Tempo
documentation for deeper info. When Tempo&rsquo;s implementation for Scala is complete, Overwatch plans to
simply reference it as a dependency.</p>
<p>This is discussed here because these functionalities have been made public through Overwatch which
means you can easily utilize &ldquo;lookupWhen&rdquo; and &ldquo;asofJoin&rdquo; when interrogating Overwatch. The details for
optimizing skewed windows is beyond the scope of this documentation but please do reference the Tempo
documentation for more details.</p>
<p>In the example below, assume you wanted the cluster name at the time of some event in a fact table.
Since cluster names can be edited, this name could be different throughout time so what was that
value at the time of some event in a driving table.</p>
<p>The function signature for &ldquo;lookupWhen&rdquo; is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> lookupWhen<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                  rightTSDF<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">TSDF</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                  leftPrefix<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                  rightPrefix<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;right_&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                  maxLookback<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Window</span><span style="color:#f92672">.</span>unboundedPreceding<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                  maxLookAhead<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Window</span><span style="color:#f92672">.</span>currentRow<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                  tsPartitionVal<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                  fraction<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Double</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">TSDF</span> <span style="color:#f92672">=</span> <span style="color:#f92672">???</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> com.databricks.labs.overwatch.pipeline.TransformFunctions._
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">val</span> metricDf <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Seq</span><span style="color:#f92672">((</span><span style="color:#e6db74">&#34;cluster_id&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1609459200000L</span><span style="color:#f92672">)).</span>toDF<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;partCol&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;metric&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">val</span> lookupDf <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Seq</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;0218-060606-rouge895&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;my_clusters_first_name&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1609459220320L</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;0218-060606-rouge895&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;my_clusters_new_name&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1609458708728L</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">).</span>toDF<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;cluster_id&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;cluster_name&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>metricDf<span style="color:#f92672">.</span>toTSDF<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;cluster_id&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">.</span>lookupWhen<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    lookupDf<span style="color:#f92672">.</span>toTSDF<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;cluster_id&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">.</span>df
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">.</span>show<span style="color:#f92672">(</span><span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span></code></pre></div>

<footer class="footline">
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="https://databrickslabs.github.io/overwatch/dataengineer/productionizing/" title="Productionizing"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="https://databrickslabs.github.io/overwatch/changelog/" title="ChangeLog" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://databrickslabs.github.io/overwatch/js/clipboard.min.js?1680128264"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/perfect-scrollbar.min.js?1680128264"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/perfect-scrollbar.jquery.min.js?1680128264"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/jquery.sticky.js?1680128264"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/featherlight.min.js?1680128264"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/highlight.pack.js?1680128264"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://databrickslabs.github.io/overwatch/js/modernizr.custom-3.6.0.js?1680128264"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/learn.js?1680128264"></script>
    <script src="https://databrickslabs.github.io/overwatch/js/hugo-learn.js?1680128264"></script>

    <link href="https://databrickslabs.github.io/overwatch/mermaid/mermaid.css?1680128264" rel="stylesheet" />
    <script src="https://databrickslabs.github.io/overwatch/mermaid/mermaid.js?1680128264"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

